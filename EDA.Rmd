---
title: "EDA"
author: "Shane Hauck"
date: "2024-03-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Packages

```{r}
library(tidyverse)

```

# Load StatsBomb Package

```{r}
library(StatsBombR)

```

# Load Data

```{r}
# Premier League 2015/16 Event Level Data
Comp <- FreeCompetitions()
Matches <- FreeMatches(Comp)
Matches <- Matches %>% filter(competition.competition_id == 2 & season.season_id == 27)
Events <- free_allevents(Matches)
Events <- allclean(Events)

```

```{r}
# World Cup 2022 360 Freeze Frame Data
Comp <- FreeCompetitions()
Matches <- FreeMatches(Comp)
Matches <- Matches %>% filter(competition.competition_id == 43 & season.season_id == 106)
data360 <- free_allevents_360(MatchesDF = Matches, Parallel = T)

events <- free_allevents(MatchesDF = Matches, Parallel = T)
events <- allclean(events)
events <- get.opposingteam(events)

data360 <- data360 %>% rename(id = event_uuid)
events <- events %>% left_join(data360, by = c("id" = "id"))
events <- events %>%
  rename(match_id = match_id.x) %>%
  select(-match_id.y)
```

# Dataset with only relevant columns for research

```{r}
interestCols <- c(
  "id", "index", "match_id", 
  "period", "timestamp", "minute", "second", "possession",
  "duration", "TimeInPoss", "milliseconds", "ElapsedTime", "StartOfPossession", "TimeToPossEnd",
  "related_events",  
  "possession_team.id", "possession_team.name", "tactics.formation",
  "player.id", "player.name", "position.id", "position.name", 
   "type.id", "type.name", "play_pattern.id", "play_pattern.name", "location.x", "location.y", 
  "pass.length", "pass.angle", "pass.end_location.x", "pass.end_location.y", 
  "pass.outcome.id", "pass.outcome.name", "pass.recipient.id", "pass.recipient.name",
  "pass.height.id", "pass.height.name", "pass.type.id", "pass.type.name",
  "pass.body_part.id", "pass.body_part.name", "pass.technique.id", "pass.technique.name",
  "pass.switch", "pass.aerial_won", "pass.assisted_shot_id", "pass.shot_assist",
  "pass.cross", "pass.cut_back", "pass.through_ball", "pass.deflected", 
  "carry.end_location.x", "carry.end_location.y", "under_pressure",
  "ball_receipt.outcome.id", "ball_receipt.outcome.name", 
  "freeze_frame", "visible_area"
  
)
```

# Filter for relevant columns

```{r}
events_rel <- events %>% select(all_of(interestCols))

```

# Sum duration of related events

```{r}
events_time <- events_rel %>% 
  filter(type.name %in% c("Carry", "Pass")) %>%
  group_by(match_id) %>%
  arrange(match_id, index) %>%
  mutate(index = row_number()) %>%
  select(id, index, related_events, duration, type.name, player.name) %>%
  # When player.name is equal for sequential index, sum the duration
  mutate(change = player.name != lag(player.name, default = player.name[1])) %>%
  mutate(group_id = cumsum(change)) %>%
  group_by(match_id, group_id) %>%
  reframe(id, totalTimeInPoss = sum(duration, na.rm = TRUE)) %>%
  select(-group_id) %>%
  ungroup()
  

```

# Merge totalTimeInPoss with events_rel

```{r}
events_rel <- events_rel %>% left_join(events_time, by = c("id" = "id"))

```

# Filter for only passes (*for now)

```{r}
p_df <- events_rel %>% filter(type.name %in% c("Pass"))

```

# Plot the distribution of totalTimeInPoss

```{r}
p_df %>% ggplot(aes(totalTimeInPoss)) +
  geom_histogram(bins = 50) +
  facet_wrap(~type.name)
  labs(title = "Distribution of Max Related Duration for Passes",
       x = "Total Time In Possessiona",
       y = "Count")

```

# Plot correlation with pass length and max_related_duration

```{r}
p_df %>% ggplot(aes(pass.length, totalTimeInPoss)) +
  geom_point(alpha = 0.25) +
  labs(title = "Correlation between Pass Length and Max Related Duration",
       x = "Pass Length",
       y = "Max Related Duration")


```

# Filter only carries (*for now)
```{r}
c_df <- events_rel %>% filter(type.name %in% c("Carry"))
```

# Plot the distribution of totalTimeInPoss

```{r}
c_df %>% ggplot(aes(totalTimeInPoss)) +
  geom_histogram(bins = 50) +
  labs(title = "Distribution of Max Related Duration for Carries",
       x = "Total Time In Possessiona",
       y = "Count")

```

